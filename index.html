<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¨Ø§Ø²ÛŒ | Ù†Ø³Ø®Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- General Setup --- */
        :root { --primary: #8e44ad; --secondary: #00cec9; --bg: #1e272e; --card-bg: #2d3436; --text: #ecf0f1; --danger: #ff7675; --success: #00b894; --warning: #f1c40f; --info: #3498db; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tahoma', sans-serif; }
        body { background-color: var(--bg); color: var(--text); padding-bottom: 80px; }
        
        /* --- Header & Navigation --- */
        header { background-color: #000; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .logo { font-size: 1.5rem; color: var(--secondary); font-weight: bold; }
        
        nav { display: flex; align-items: center; }
        nav button { background: none; border: none; color: #aaa; font-size: 1rem; margin: 0 5px; cursor: pointer; transition: 0.3s; padding: 8px 10px; white-space: nowrap; }
        nav button.active, nav button:hover { color: var(--secondary); border-bottom: 2px solid var(--secondary); }
        .cart-badge { background-color: var(--danger); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.8rem; vertical-align: top; }

        /* --- User Menu --- */
        .user-menu-container { position: relative; display: inline-block; }
        .user-dropdown { position: absolute; top: 45px; left: 0; right: auto; background-color: var(--card-bg); border: 1px solid var(--primary); border-radius: 5px; min-width: 160px; z-index: 200; box-shadow: 0 4px 8px rgba(0,0,0,0.5); display: none; padding: 5px 0; text-align: right; }
        .user-dropdown.show { display: block; }
        .user-dropdown button { display: block; width: 100%; padding: 12px 15px; text-align: right; background: none; border: none; color: var(--text); cursor: pointer; border-bottom: 1px solid #444; }
        .user-dropdown button:hover { background-color: #3e4449; }
        
        /* --- Sections & Grid --- */
        .container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }

        /* --- Cards --- */
        .card { background-color: var(--card-bg); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; }
        .card img { width: 100%; height: 180px; object-fit: cover; }
        .card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { font-size: 1.1rem; margin-bottom: 10px; font-weight: bold; }
        .price-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .price-new { color: var(--success); font-size: 1.1rem; font-weight: bold; }
        .price-old { color: #777; text-decoration: line-through; font-size: 0.85rem; }

        .specs-list { list-style: none; padding: 0; margin-top: 10px; border-top: 1px solid #444; padding-top: 10px; }
        .specs-list li { background-color: #3e4449; padding: 4px 8px; border-radius: 3px; margin-bottom: 4px; font-size: 0.85em; }

        /* --- UI Elements --- */
        .category-menu { margin-bottom: 20px; text-align: center; overflow-x: auto; white-space: nowrap; padding-bottom: 10px; }
        .category-menu button { background-color: #333; color: var(--text); border: none; padding: 8px 15px; margin: 0 5px; border-radius: 20px; cursor: pointer; transition: 0.2s; }
        .category-menu button:hover, .category-menu button.active { background-color: var(--primary); }

        .form-box { background: var(--card-bg); padding: 25px; border-radius: 10px; max-width: 500px; margin: 0 auto; border: 1px solid #444; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #bdc3c7; text-align: right; font-size: 0.9em; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; background: #111; border: 1px solid #555; color: white; border-radius: 5px; text-align: right; direction: rtl; font-size: 1rem; } 
        .error-message { color: var(--danger); text-align: center; margin-bottom: 15px; font-weight: bold; display: none; }
        
        .payment-info { background: #3c3f41; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px dashed var(--secondary); text-align: right; }
        .payment-info h4 { margin-top: 0; color: var(--secondary); margin-bottom: 10px; }

        /* --- Buttons --- */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 1rem; }
        .btn-add { background-color: var(--primary); color: white; }
        .btn-add:hover { background-color: #9b59b6; }
        .btn-del { background-color: var(--danger); color: white; margin-top: 5px; }
        .btn-edit { background-color: var(--info); color: white; margin-top: 5px; margin-right: 5px; }
        .btn-link { background: none; color: var(--secondary); border: none; cursor: pointer; text-align: center; display: block; width: 100%; margin-top: 10px; padding: 10px; }
        .btn-cancel { background-color: var(--danger); color: white; margin-top: 10px; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-password { background-color: #2ecc71; color: white; padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem;}
        .btn-admin-action { background-color: var(--warning); color: #1e272e; margin-top: 15px; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        /* --- Summaries & Admin --- */
        footer { text-align: center; margin-top: 50px; padding: 20px; border-top: 1px solid #333; color: #777; font-size: 0.9rem; }
        .order-summary { background-color: #3c3f41; padding: 15px; border-radius: 8px; margin-bottom: 15px; direction: rtl; text-align: right; border-right: 5px solid; }
        .order-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .order-details { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #555; display: none; }
        .order-details.show { display: block; }
        .profile-info-box { background-color: var(--card-bg); padding: 20px; border-radius: 10px; max-width: 600px; margin: 20px auto; border: 1px solid var(--secondary); text-align: right; }
        .profile-info-box h3 { color: var(--primary); border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; }
        .search-container { margin-bottom: 20px; max-width: 500px; margin: 0 auto 20px auto; }
        .search-container input { background: #333; border: 1px solid #555; padding: 12px; border-radius: 5px; color: white; width: 100%; text-align: right; }

        /* --- Modal --- */
        .modal { display: none; position: fixed; z-index: 500; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); padding-top: 40px; }
        .modal-content { background-color: var(--card-bg); margin: 5% auto; padding: 25px; border: 1px solid var(--primary); width: 90%; max-width: 500px; border-radius: 10px; text-align: right; position: relative; }
        .close-btn { color: #aaa; position: absolute; left: 20px; top: 15px; font-size: 28px; font-weight: bold; }
        .close-btn:hover { color: var(--danger); cursor: pointer; }
        .modal-title { color: var(--secondary); margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }

        /* --- Admin Table --- */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 20px; }
        .user-table { width: 100%; border-collapse: collapse; text-align: right; min-width: 500px; /* Ensure table doesn't squish too much */ }
        .user-table th, .user-table td { padding: 12px 15px; border: 1px solid #444; }
        .user-table th { background-color: var(--primary); color: white; text-align: center; white-space: nowrap; }
        .user-table td { background-color: var(--card-bg); vertical-align: middle; }
        
        .category-list { list-style: none; padding: 0; max-width: 300px; margin: 15px auto; }
        .category-list li { background-color: #3e4449; padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }

        /* --- RTL Helpers --- */
        .container h2 { text-align: right; }
        input { direction: rtl; text-align: right; }
        
        /* ================= MOBILE OPTIMIZATION (Responsive) ================= */
        @media screen and (max-width: 768px) {
            /* Header Adjustment */
            header { flex-direction: column; gap: 15px; padding: 10px 5px; }
            .logo { margin-bottom: 5px; }
            nav { width: 100%; justify-content: center; flex-wrap: wrap; }
            nav button { flex: 1 1 auto; font-size: 0.9rem; padding: 10px 5px; margin: 2px; text-align: center; }
            
            /* User Menu Position Fix for Mobile */
            .user-menu-container { width: 100%; text-align: center; margin-top: 5px; }
            .user-dropdown { width: 100%; top: 100%; position: relative; margin-top: 5px; box-shadow: none; border: 1px solid #444; }

            /* Grid & Layout */
            .container { padding: 0 10px; margin-top: 15px; }
            .grid { grid-template-columns: 1fr; /* Single column on phones */ }
            
            /* Admin Panels */
            .admin-tab-content button.btn-link { display: inline-block; width: auto; margin: 5px; padding: 8px 15px; background: #333; border-radius: 20px; }
            
            /* Card & Text Adjustments */
            .card-title { font-size: 1rem; }
            .price-new { font-size: 1rem; }
            
            /* Form Inputs */
            .form-group input, .form-group select { font-size: 16px; /* Prevents zoom on iOS */ }
            .form-group { display: flex; flex-direction: column; }
            /* Fix dual input rows on mobile */
            .form-group[style*="display:flex"] { flex-direction: row; } 
        }
    </style>
</head>
<body>

    <header>
        <div class="logo"><i class="fas fa-gamepad"></i> ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ú¯ÛŒÙ…</div>
        <nav>
            <button onclick="switchTab('shop')" id="tab-shop" class="active"><i class="fas fa-store"></i> Ù…Ø­ØµÙˆÙ„Ø§Øª</button>
            <button onclick="switchTab('cart')" id="tab-cart"><i class="fas fa-shopping-cart"></i> <span id="cart-count" class="cart-badge">0</span></button>
            <button onclick="switchTab('about')" id="tab-about"><i class="fas fa-info-circle"></i> Ø¯Ø±Ø¨Ø§Ø±Ù‡</button>
        
            <span id="user-auth-area" style="display: flex; justify-content: center;"></span>
        </nav>
    </header>

    <div class="container">
        
        <div id="shop" class="section active">
            <h2 style="margin-bottom: 20px;">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ù…Ø­ØµÙˆÙ„Ø§Øª</h2>
            <div class="search-container">
                <input type="text" id="product-search-input" oninput="renderShop()" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„..." 
/>
            </div>
            <div class="category-menu" id="category-menu"></div>
            <div class="grid" id="product-grid"></div>
        </div>

        <div id="cart" class="section">
            <h2 style="margin-bottom: 20px;">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§</h2>
            <div id="cart-items"></div>
            <div 
class="shipping-cost-row">
                <span>Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„:</span>
                <span id="shipping-cost-display"></span>
            </div>
            <div class="cart-total" id="cart-total" style="font-weight: bold;
margin-top: 15px; font-size: 1.1em;">Ø¬Ù…Ø¹ Ú©Ù„ Ù†Ù‡Ø§ÛŒÛŒ: Û° ØªÙˆÙ…Ø§Ù†</div>
            <button class="btn btn-add" style="margin-top: 20px;" onclick="goToShipping()">Ù†Ù‡Ø§ÛŒÛŒ Ú©Ø±Ø¯Ù† Ø®Ø±ÛŒØ¯</button>
        </div>

        <div id="about" class="section">
            <h2 style="margin-bottom: 20px;
text-align: center;">Ø¯Ø±Ø¨Ø§Ø±Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù…Ø§</h2>
            <div class="form-box" style="max-width: none;">
                <p style="text-align: right;
margin-bottom: 20px; line-height: 1.8;">
                    Ù…Ø§ ÛŒÚ© ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ† ØªØ®ØµØµÛŒ Ø¯Ø± Ø²Ù…ÛŒÙ†Ù‡ Ú©Ù†Ø³ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ùˆ Ù„ÙˆØ§Ø²Ù… Ø¬Ø§Ù†Ø¨ÛŒ Ù‡Ø³ØªÛŒÙ…. Ù‡Ø¯Ù Ù…Ø§ Ø§Ø±Ø§Ø¦Ù‡ Ø¨Ù‡ØªØ±ÛŒÙ† Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø§ Ù‚ÛŒÙ…Øª Ø±Ù‚Ø§Ø¨ØªÛŒ Ùˆ ØªØ¶Ù…ÛŒÙ† Ø§ØµØ§Ù„Øª Ú©Ø§Ù„Ø§ Ø§Ø³Øª.
                </p>
                <h3 style="text-align: right;
color: var(--primary);">Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³:</h3>
                <p style="text-align: right;"><i class="fas fa-phone-alt"></i> **Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:** Û°Û¹Û±Û¸Û²Û´Û³Û³ÛµÛ°Û·</p>
                <p style="text-align: right;"><i class="fas fa-map-marker-alt"></i> **Ø¢Ø¯Ø±Ø³:** Ú©Ø±Ø¯Ø³ØªØ§Ù†ØŒ Ø³Ù†Ù†Ø¯Ø¬</p>
            </div>
        </div>

        <div id="login" class="section">
            <h2 style="text-align: center;
margin-bottom: 20px;">ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±</h2>
            <div class="form-box">
                <div id="login-error" class="error-message">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!</div>
                <form onsubmit="handleUserLogin(event)">
                    <div class="form-group">
                       
 <label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ø¯Ù…ÛŒÙ†: superuser):</label>
                        <input type="text" id="user-login-username" required>
                    </div>
                    <div class="form-group">
                        <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</label>
   
 <input type="password" id="user-login-password" required>
                    </div>
                    <button type="submit" class="btn btn-add">ÙˆØ±ÙˆØ¯</button>
                    <button type="button" class="btn-link" onclick="switchTab('register')">Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯</button>
     
            </form>
            </div>
        </div>

        <div id="register" class="section">
            <h2 style="text-align: center;
margin-bottom: 20px;">Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h2>
            <div class="form-box">
                <div id="register-error" class="error-message"></div>
                <form onsubmit="handleUserRegister(event)">
                    <div class="form-group">
                        <label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ:</label>
   
 <input type="text" id="user-reg-username" required>
                    </div>
                    <div class="form-group">
                        <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</label>
          
 <input type="password" id="user-reg-password" required>
                    </div>
                    <button type="submit" class="btn btn-add">Ø«Ø¨Øª Ù†Ø§Ù…</button>
                    <button type="button" class="btn-link" onclick="switchTab('login')">Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</button>
           
      </form>
            </div>
        </div>

        <div id="shipping" class="section">
            <h2 style="text-align: center;
margin-bottom: 20px;">ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø±Ø³Ø§Ù„ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª</h2>
            <div class="form-box">
                <div class="payment-info" style="border: 1px solid var(--primary);">
                    <h4><i class="fas fa-money-bill-wave"></i> Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ:</h4>
                    <p id="final-total-display" style="font-size: 1.5em;
font-weight: bold; color: var(--success);"></p>
                </div>
                <div class="payment-info">
                    <h4><i class="fas fa-university"></i> Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª ÙˆØ§Ø±ÛŒØ²:</h4>
                    <p style="font-size: 1.2em;
font-weight: bold; color: var(--text);">Û±Û²Û°Û´ **** **** Û±Û³Û¹Û¸</p>
                    <p style="font-size: 0.9em;
color: #ccc;">**ØªÙˆØ¬Ù‡:** Ú©Ù„ Ù…Ø¨Ù„Øº Ø±Ø§ Ø¨Ù‡ Ø§ÛŒÙ† Ú©Ø§Ø±Øª ÙˆØ§Ø±ÛŒØ² Ù†Ù…Ø§ÛŒÛŒØ¯.</p>
                </div>

                <form onsubmit="submitShippingForm(event)">
                    <div class="form-group"><label>Ù†Ø§Ù… Ú¯ÛŒØ±Ù†Ø¯Ù‡:</label><input type="text" id="ship-name" required></div>
                    <div class="form-group"><label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</label><input type="tel" id="ship-phone" required></div>
        
             <div class="form-group"><label>Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„:</label><input type="text" id="ship-address" required></div>
                    <div class="form-group" style="display:flex;
gap:10px;">
                        <input type="number" id="ship-plaque" placeholder="Ù¾Ù„Ø§Ú©" required style="width: 30%;">
                        <input type="text" id="ship-postal" placeholder="Ú©Ø¯ Ù¾Ø³ØªÛŒ" required style="width: 70%;">
                    </div>
                   
 
                    <hr style="border-color: #555;
margin: 20px 0;">

                    <div class="form-group">
                        <label>Ù†Ø§Ù… ØµØ§Ø­Ø¨ Ú©Ø§Ø±Øª ÙˆØ§Ø±ÛŒØ²ÛŒ:</label>
                        <input type="text" id="payment-owner-name" required>
                    </div>
   
 <div class="form-group">
                        <label>Û´ Ø±Ù‚Ù… Ø¢Ø®Ø± Ú©Ø§Ø±Øª:</label>
                        <input type="text" id="payment-last-digits" maxlength="4" pattern="\d{4}" title="Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Û´ Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯" required>
                    </div>
 
 <button type="submit" class="btn btn-add">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ</button>
                </form>
            </div>
        </div>

        <div id="user-orders" class="section">
            <h2 style="text-align: center;
margin-bottom: 20px;">Ø³ÙØ§Ø±Ø´Ø§Øª Ù…Ù†</h2>
            <div id="user-orders-list"></div>
        </div>
        
        <div id="profile" class="section">
            <h2 style="text-align: center;
margin-bottom: 20px;">ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</h2>
            <div id="user-profile-info"></div>
        </div>

        <div id="admin" class="section">
            <h2 style="text-align: center;
margin-bottom: 20px;">ğŸ›  Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†</h2>
            <div style="text-align: center; margin-bottom: 20px;
overflow-x: auto; white-space: nowrap;">
                <button onclick="showAdminTab('products')" id="admin-tab-products" class="btn-link active" style="display:inline-block;
width:auto;">Ù…Ø­ØµÙˆÙ„Ø§Øª</button>
                <button onclick="showAdminTab('categories')" id="admin-tab-categories" class="btn-link" style="display:inline-block;
width:auto;">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</button>
                <button onclick="showAdminTab('orders')" id="admin-tab-orders" class="btn-link" style="display:inline-block;
width:auto;">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</button>
                <button onclick="showAdminTab('users')" id="admin-tab-users" class="btn-link" style="display:inline-block;
width:auto;">Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button> 
            </div>

            <div id="admin-products" class="admin-tab-content active">
                <div class="form-box" style="max-width: none;">
                    <h3 style="color:var(--secondary);
text-align: center; margin-bottom: 15px;">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„</h3>
                    <form onsubmit="addProduct(event)">
                        <div class="grid" style="gap:10px;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                            <input type="text" id="p-name" required placeholder="Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„">
                            <select id="p-category" class="category-select" style="padding: 10px;
background: #111; border: 1px solid #555; color: white; border-radius: 5px;
cursor: pointer;"></select>
                            <input type="text" id="p-img" required placeholder="Ù„ÛŒÙ†Ú© ØªØµÙˆÛŒØ±">
                            <input type="number" id="p-price" required placeholder="Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†)">
                            <input type="number" id="p-off" placeholder="Ù‚ÛŒÙ…Øª Ø¨Ø§ 
ØªØ®ÙÛŒÙ">
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label>Ù…Ø´Ø®ØµØ§Øª ÙÙ†ÛŒ:</label>
                    
 <input type="text" id="p-spec1" placeholder="Ù…Ø«Ø§Ù„: Ø­Ø§ÙØ¸Ù‡: 1 ØªØ±Ø§Ø¨Ø§ÛŒØª" style="margin-bottom:5px;">
                            <input type="text" id="p-spec2" placeholder="Ù…Ø«Ø§Ù„: Ø±Ù†Ú¯: Ù…Ø´Ú©ÛŒ" style="margin-bottom:5px;">
                            <input type="text" id="p-spec3" placeholder="Ù…Ø«Ø§Ù„: Ú¯Ø§Ø±Ø§Ù†ØªÛŒ: 12 Ù…Ø§Ù‡Ù‡">
                 
        </div>
                        <button type="submit" class="btn btn-add">Ø§ÙØ²ÙˆØ¯Ù†</button>
                    </form>
                </div>
                <h3 style="color:var(--warning);
text-align: right; margin-top: 30px;">Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª</h3>
                <div class="grid" id="admin-grid" style="margin-top: 20px;"></div>
            </div>

            <div id="admin-categories" class="admin-tab-content">
                <div class="form-box" style="max-width: 300px;">
                    <form onsubmit="addCategory(event)">
          
 <div class="form-group">
                            <label>Ù†Ø§Ù… Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¬Ø¯ÛŒØ¯:</label>
                            <input type="text" id="new-category-name" required placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„">
                     
    </div>
                        <button type="submit" class="btn btn-add">Ø§ÙØ²ÙˆØ¯Ù†</button>
                    </form>
                    <hr style="border-color: #555;
margin: 20px 0;">
                    <h4 style="text-align: center;">Ù„ÛŒØ³Øª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</h4>
                    <ul id="category-management-list" class="category-list"></ul>
                </div>
            </div>

            <div id="admin-orders" class="admin-tab-content">
           
 <div class="search-container">
                    <input type="text" id="order-search-input" oninput="renderAdminOrders()" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù…Ø´ØªØ±ÛŒ..." />
                </div>
                <div id="orders-list"></div>
            </div>

            <div id="admin-users" class="admin-tab-content">
                <div class="form-box" style="max-width: none; margin-bottom: 20px; border-color: var(--warning);">
                    <h4 style="color: var(--warning); text-align: center;">âš™ï¸ Ø§Ø¨Ø²Ø§Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø³ØªÛŒ (Manual Sync Tool)</h4>
                    <p style="font-size: 0.9em; text-align: center; color: #ccc;">(ØªÙ†Ù‡Ø§ Ø±Ø§Ù‡ Ø¨Ø¯ÙˆÙ† Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¬Ø¯ÛŒØ¯)</p>
                    <button class="btn btn-admin-action" style="background-color: var(--warning); color: #000; margin-bottom: 15px;" onclick="exportProductsData()">
                        Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø±Ø§ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ
                    </button>
                    <pre id="exported-products-data" style="white-space: pre-wrap; word-wrap: break-word; background: #000; padding: 10px; border: 1px dashed #fff; border-radius: 5px; max-height: 200px; overflow-y: auto; text-align: left; direction: ltr; display: none; font-size: 0.8em;"></pre>
                </div>
                <h3 style="color:var(--secondary); text-align: right;
margin-bottom: 15px;">Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
                <div class="search-container">
                    <input type="text" id="user-search-input" oninput="renderAdminUsers()" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ..." />
                </div>
                <div id="users-list-container" class="table-responsive"></div>
            </div>
        
 </div>

    </div>
    
    <div id="admin-password-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('admin-password-modal')">&times;</span>
            <h3 class="modal-title"><i class="fas fa-key"></i> Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø¯Ù…ÛŒÙ†</h3>
            <form id="change-admin-password-form" onsubmit="event.preventDefault();
changeAdminPassword(event);">
                <div class="form-group"><label>Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯:</label><input type="password" id="new-admin-password" required></div>
                <div class="form-group"><label>ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø²:</label><input type="password" id="confirm-admin-password" required></div>
                <button type="submit" class="btn btn-admin-action">ØªØºÛŒÛŒØ± Ø±Ù…Ø²</button>
            </form>
            <p style="color: var(--danger);
text-align: center; margin-top: 10px;" id="admin-password-error"></p>
        </div>
    </div>

    <div id="user-password-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('user-password-modal')">&times;</span>
            <h3 class="modal-title">ØªØºÛŒÛŒØ± Ø±Ù…Ø²: <span id="target-username-display" style="color: var(--warning);"></span></h3>
            <p style="color: #ccc;
text-align: center; margin-bottom: 15px;">Ø±Ù…Ø² ÙØ¹Ù„ÛŒ: <span id="current-user-password-display" style="font-weight: bold;"></span></p>
            <form id="change-user-password-form" onsubmit="event.preventDefault();
saveUserPasswordChange();">
                <input type="hidden" id="target-username-input">
                <div class="form-group"><label>Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯:</label><input type="password" id="new-user-password" required></div>
                <div class="form-group"><label>ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø²:</label><input type="password" id="confirm-user-password" required></div>
                <button type="submit" class="btn btn-admin-action">Ø°Ø®ÛŒØ±Ù‡</button>
            </form>
         
 <p style="color: var(--danger); text-align: center; margin-top: 10px;" id="user-password-error"></p>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('edit-modal')">&times;</span>
            <h3 class="modal-title"><i class="fas fa-edit"></i> ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„</h3>
            <form id="edit-product-form" onsubmit="event.preventDefault();
saveEditedProduct(this.dataset.productId);">
                <div class="form-group"><label>Ù†Ø§Ù…:</label><input type="text" id="edit-p-name" required></div>
                <div class="form-group"><label>Ø¯Ø³ØªÙ‡:</label><select id="edit-p-category" class="category-select"></select></div>
                <div class="form-group"><label>ØªØµÙˆÛŒØ±:</label><input type="text" id="edit-p-img" required></div>
                <div class="form-group"><label>Ù‚ÛŒÙ…Øª:</label><input type="number" id="edit-p-price" required></div>
                <div class="form-group"><label>ØªØ®ÙÛŒÙ:</label><input type="number" id="edit-p-off"></div>
  
 <div class="form-group" style="margin-top: 15px;">
                    <label>Ù…Ø´Ø®ØµØ§Øª ÙÙ†ÛŒ:</label>
                    <input type="text" id="edit-p-specs1" placeholder="Ù…Ø´Ø®ØµÙ‡ Ø§ÙˆÙ„">
                    <input type="text" id="edit-p-specs2" placeholder="Ù…Ø´Ø®ØµÙ‡ Ø¯ÙˆÙ…" style="margin-top: 5px;">
            
 <input type="text" id="edit-p-specs3" placeholder="Ù…Ø´Ø®ØµÙ‡ Ø³ÙˆÙ…" style="margin-top: 5px;">
                </div>
                <button type="submit" class="btn btn-add">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
            </form>
        </div>
    </div>

    <footer>
        <p>&copy;
Û±Û´Û°Û³ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ú¯ÛŒÙ… - Ú©Ù„ÛŒÙ‡ Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª.</p>
    </footer>

    <script>
        // --- CONSTANTS ---
        const ADMIN_RESERVED_USERNAME = 'superuser';
        const SHIPPING_COST = 100000;

        // --- DATA ---
        // Ø§ÛŒÙ† Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ ØªÙˆØ³Ø· Ø§Ø¯Ù…ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´ÙˆØ¯ (Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø¨Ø²Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†)
        const defaultProducts = [
            { id: 1, name: "Ú©Ù†Ø³ÙˆÙ„ PS5", price: 28000000, off: 26500000, img: "https://via.placeholder.com/300/4e5458/ffffff?text=PS5", category: "Ú©Ù†Ø³ÙˆÙ„", specs: "Ø­Ø§ÙØ¸Ù‡: 1 ØªØ±Ø§Ø¨Ø§ÛŒØª, Ø±Ù†Ú¯: Ø³ÙÛŒØ¯, Ú¯Ø§Ø±Ø§Ù†ØªÛŒ: 12 Ù…Ø§Ù‡Ù‡" },
            { id: 2, name: "Ø¯Ø³ØªÙ‡ Ø§ÛŒÚ©Ø³ Ø¨Ø§Ú©Ø³", price: 3500000, off: null, img: "https://via.placeholder.com/300/4e5458/ffffff?text=XBOX", category: "Ù„ÙˆØ§Ø²Ù… Ø¬Ø§Ù†Ø¨ÛŒ", specs: "Ø±Ù†Ú¯: Ù…Ø´Ú©ÛŒ, Ø³Ù†Ø³ÙˆØ±: Ø´ØªØ§Ø¨ Ø³Ù†Ø¬" },
            { id: 3, name: "Ú©Ù†Ø³ÙˆÙ„ XBOX Series X", price: 29000000, off: 27500000, img: "https://via.placeholder.com/300/4e5458/ffffff?text=XBOX+SX", category: "Ú©Ù†Ø³ÙˆÙ„", specs: "Ø­Ø§ÙØ¸Ù‡: 1 ØªØ±Ø§Ø¨Ø§ÛŒØª, Ø±Ù†Ú¯: Ù…Ø´Ú©ÛŒ, Ú¯Ø§Ø±Ø§Ù†ØªÛŒ: 18 Ù…Ø§Ù‡Ù‡" },
        ];
        const defaultCategories = ["Ú©Ù†Ø³ÙˆÙ„", "Ù„ÙˆØ§Ø²Ù… Ø¬Ø§Ù†Ø¨ÛŒ"];
        let products = JSON.parse(localStorage.getItem('gs_products')) || defaultProducts;
        let categories = JSON.parse(localStorage.getItem('gs_categories')) || defaultCategories;
        let cart = JSON.parse(localStorage.getItem('gs_cart')) || [];
        
        // --- Ø§ØµÙ„Ø§Ø­ÛŒÙ‡ Ø§Ù…Ù†ÛŒØªÛŒ: Ø­ÙØ¸ Ø±Ù…Ø² Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø± Local Storage ---
        let users = JSON.parse(localStorage.getItem('gs_users'));
        if (!users) {
            // Ø§Ú¯Ø± Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± Ø§Ø³ØªØŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§ Ø±Ù…Ø² Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†.
            users = [{ username: ADMIN_RESERVED_USERNAME, password: hashPassword('adminpass') }];
        }
        
        let orders = JSON.parse(localStorage.getItem('gs_orders')) || [];
        // Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ Ø§Ø² localStorage Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†ÛŒÙ…
        let currentUser = localStorage.getItem('gs_currentUser');
        // Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø±Ø´ØªÙ‡â€ŒÛŒ "null" ÛŒØ§ Ø±Ø´ØªÙ‡â€ŒÛŒ Ø®Ø§Ù„ÛŒ "" Ø¨ÙˆØ¯ØŒ Ø¢Ù† Ø±Ø§ Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ù‚Ø¹ÛŒ null ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
        if (currentUser === 'null' || currentUser === '') {
            currentUser = null;
        }

        let isAdminLoggedIn = localStorage.getItem('gs_isAdmin') === 'true';
        let lastShippingInfo = JSON.parse(localStorage.getItem('gs_lastShippingInfo')) || {};
        let currentFilter = 'Ù‡Ù…Ù‡';
        
        // --- CORE FUNCTIONS ---
        
        /**
         * @description Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù‡Ø´ Ú©Ø±Ø¯Ù† Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø¯Ø± Ù…Ø­ÛŒØ· ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ÛŒØ¯ Ø§Ø² Bcrypt Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯)
         * @param {string} password - Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª Ù…ØªÙ† Ø³Ø§Ø¯Ù‡
         * @returns {string} Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù‡Ø´ Ø´Ø¯Ù‡
         */
        function hashPassword(password) {
            // Ø§Ø² Ù‡Ø´ Ø³Ø§Ø¯Ù‡ Ùˆ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª MD5 Ø¨Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.
            // ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ØµØ±ÙØ§Ù‹ Ø¨Ø±Ø§ÛŒ Local Storage Ø§Ø³Øª Ùˆ Ø¯Ø± Ø³Ø±ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø§Ø² Bcrypt ÛŒØ§ Argon2 Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯.
            function toHex(buffer) {
                return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
            }
            if (!password) return '';
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                hash = (hash << 5) - hash + password.charCodeAt(i);
                hash |= 0; // Convert to 32bit integer
            }
            return hash.toString(16) + toHex(new TextEncoder().encode(password).slice(0, 4));
        }

        function saveData() {
            localStorage.setItem('gs_products', JSON.stringify(products));
            localStorage.setItem('gs_categories', JSON.stringify(categories));
            localStorage.setItem('gs_cart', JSON.stringify(cart));
            localStorage.setItem('gs_users', JSON.stringify(users));
            localStorage.setItem('gs_orders', JSON.stringify(orders));
            // Ø§ØµÙ„Ø§Ø­ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Ø±Ø´ØªÙ‡ "null" Ø¯Ø± Local Storage
            localStorage.setItem('gs_currentUser', currentUser || ''); 
            localStorage.setItem('gs_isAdmin', isAdminLoggedIn);
            localStorage.setItem('gs_lastShippingInfo', JSON.stringify(lastShippingInfo));
            render();
        }
        
        // --- NEW FUNCTION FOR MANUAL SYNC ---
        function exportProductsData() {
            if (!isAdminLoggedIn) return alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯.');
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¢Ø±Ø§ÛŒÙ‡ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ù‡ ØµÙˆØ±Øª JSON Ø²ÛŒØ¨Ø§ Ø¨Ø±Ø§ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ø¢Ø³Ø§Ù† Ø¯Ø± Ú©Ø¯
            const data = JSON.stringify(products, null, 4); 
            const preEl = document.getElementById('exported-products-data');
            preEl.innerText = data;
            preEl.style.display = 'block';
            alert('âœ… Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¯Ø± Ú©Ø§Ø¯Ø± Ø²ÛŒØ± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯. Ø¢Ù† Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯Ø± Ú©Ø¯ Ø®ÙˆØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø¢Ø±Ø§ÛŒÙ‡ defaultProducts Ú©Ù†ÛŒØ¯ ØªØ§ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯ Ù†ÛŒØ² Ø¢Ù† Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ù†Ø¯.');
        }

        function render() {
            renderShop();
            renderAdminProducts();
            renderAdminOrders();
            renderAdminUsers();
            renderCart();
            renderUserOrders();
            renderUserProfile();
            updateAuthArea();
            renderCategoryManagement();
            renderCategorySelectors();
            updateShippingFormTotal();
        }

        function updateAuthArea() {
            const authArea = document.getElementById('user-auth-area');
            // Ú†Ú© Ú©Ø±Ø¯Ù† currentUser. Ø§Ú¯Ø± Ø±Ø´ØªÙ‡ Ø®Ø§Ù„ÛŒ "" Ø¨Ø§Ø´Ø¯ØŒ false Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.
            if (currentUser) {
                const displayName = isAdminLoggedIn ? 'Ø§Ø¯Ù…ÛŒÙ†' : currentUser;
                authArea.innerHTML = `
                    <div class="user-menu-container">
                        <button onclick="toggleUserMenu()" style="border-bottom: 2px solid var(--secondary); margin-left: 10px;">
                            ğŸ‘‹ ${displayName} <i class="fas fa-chevron-down" style="font-size: 0.7em;"></i>
                        </button>
                        <div id="user-dropdown" class="user-dropdown">
                            <button onclick="switchTab('profile'); toggleUserMenu();"><i class="fas fa-user-circle"></i> Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
                            <button onclick="switchTab('user-orders'); toggleUserMenu();"><i class="fas fa-clipboard-list"></i> Ø³ÙØ§Ø±Ø´Ø§Øª Ù…Ù†</button>
                            ${isAdminLoggedIn ? 
                                `<button onclick="switchTab('admin'); toggleUserMenu();"><i class="fas fa-tools"></i> Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†</button>` : ''}
                            <button onclick="doLogout()"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
                        </div>
                    </div>
                `;
            } else {
                authArea.innerHTML = `
                    <button onclick="switchTab('login')"><i class="fas fa-sign-in-alt"></i> ÙˆØ±ÙˆØ¯</button>
                    <button onclick="switchTab('register')"><i class="fas fa-user-plus"></i> Ø«Ø¨Øª Ù†Ø§Ù…</button>
                `;
            }
        }

        function toggleUserMenu() {
            document.getElementById('user-dropdown').classList.toggle('show');
        }

        function switchTab(t) {
            if (t === 'admin' && !isAdminLoggedIn) return alert('ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†!');
            document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            document.querySelectorAll('nav button').forEach(e=>e.classList.remove('active'));
            const tabButton = document.getElementById('tab-' + t);
            if(tabButton) tabButton.classList.add('active');

            const menu = document.getElementById('user-dropdown');
            if (menu) menu.classList.remove('show');

            if (t === 'profile') renderUserProfile();
            if (t === 'user-orders') renderUserOrders();
            if (t === 'admin') renderAdminOrders();
            if (t === 'cart') renderCart();
        }
        
        function showAdminTab(t) {
            document.querySelectorAll('.admin-tab-content').forEach(e=>e.classList.remove('active'));
            document.getElementById('admin-'+t).classList.add('active');
            if (t === 'categories') renderCategoryManagement();
            if (t === 'products') renderCategorySelectors();
            if (t === 'orders') renderAdminOrders();
            if (t === 'users') renderAdminUsers();
            document.querySelectorAll('#admin button.btn-link').forEach(btn => btn.classList.remove('active'));
            document.getElementById('admin-tab-'+t).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- AUTHENTICATION ---
        function handleUserRegister(e) {
            e.preventDefault();
            const u = document.getElementById('user-reg-username').value.trim();
            const p = document.getElementById('user-reg-password').value;
            const errorEl = document.getElementById('register-error');
            errorEl.style.display = 'none';

            if (users.some(x => x.username === u)) {
                errorEl.innerText = 'Ø§ÛŒÙ† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.';
                errorEl.style.display = 'block';
                return;
            }
            
            if (p.length < 5) {
                errorEl.innerText = 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Ûµ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.';
                errorEl.style.display = 'block';
                return;
            }

            // Ø±Ù…Ø² Ø«Ø¨Øª Ù†Ø§Ù… Ø´Ø¯Ù‡ Ø±Ø§ Ù‡Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            users.push({username: u, password: hashPassword(p)});
            currentUser = u;
            isAdminLoggedIn = false;
            saveData();
            switchTab('shop');
        }

        function handleUserLogin(e) {
            e.preventDefault();
            const u = document.getElementById('user-login-username').value.trim();
            const p = document.getElementById('user-login-password').value;
            
            // Ø±Ù…Ø² ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø±Ø§ Ù‡Ø´ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨Ø§ Ù‡Ø´ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            const hashedP = hashPassword(p);
            const user = users.find(x => x.username===u && x.password===hashedP);
            
            if(user) {
                document.getElementById('login-error').style.display='none';
                currentUser=u;
                if (u === ADMIN_RESERVED_USERNAME) {
                    isAdminLoggedIn = true;
                    switchTab('admin');
                } else {
                    isAdminLoggedIn = false;
                    switchTab('shop');
                }
                saveData();
            } else {
                document.getElementById('login-error').style.display='block';
            }
        }

        function doLogout() {
            if(confirm('Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯ØŸ')) {
                isAdminLoggedIn=false;
                currentUser=null;
                saveData();
                switchTab('shop');
            }
        }

        // --- PASSWORD MGMT ---
        function getUserPassword(username) {
            // Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ØŒ Ø±Ù…Ø² Ù‡Ø´ Ø´Ø¯Ù‡ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
            return users.find(u => u.username === username)?.password || '---';
        }

        function openUserPasswordModal(username) {
            if (!isAdminLoggedIn) return alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯.');
            document.getElementById('target-username-display').innerText = username;
            document.getElementById('target-username-input').value = username;
            // Ø±Ù…Ø² Ù‡Ø´ Ø´Ø¯Ù‡ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
            document.getElementById('current-user-password-display').innerText = getUserPassword(username);
            document.getElementById('user-password-error').innerText = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('confirm-user-password').value = '';
            document.getElementById('user-password-modal').style.display = 'block';
        }
        
        function saveUserPasswordChange() {
            const username = document.getElementById('target-username-input').value;
            const newPass = document.getElementById('new-user-password').value;
            const confirmPass = document.getElementById('confirm-user-password').value;
            const errorEl = document.getElementById('user-password-error');
            errorEl.innerText = '';

            if (newPass !== confirmPass) {
                errorEl.innerText = 'ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯.';
                return;
            }
            if (newPass.length < 5) {
                errorEl.innerText = 'Ø­Ø¯Ø§Ù‚Ù„ Ûµ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.';
                return;
            }

            const idx = users.findIndex(u => u.username === username);
            if (idx !== -1) {
                // Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ù‡Ø´ Ú©Ø±Ø¯Ù‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                users[idx].password = hashPassword(newPass);
                saveData();
                alert('âœ… Ø±Ù…Ø² ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.');
                closeModal('user-password-modal');
                renderAdminUsers();
            }
        }

        function changeAdminPassword(e) {
            const newPass = document.getElementById('new-admin-password').value;
            const confirmPass = document.getElementById('confirm-admin-password').value;
            const errorEl = document.getElementById('admin-password-error');
            errorEl.innerText = '';

            if (newPass !== confirmPass) {
                errorEl.innerText = 'ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯.';
                return;
            }
            if (newPass.length < 5) {
                errorEl.innerText = 'Ø­Ø¯Ø§Ù‚Ù„ Ûµ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.';
                return;
            }

            const idx = users.findIndex(u => u.username === ADMIN_RESERVED_USERNAME);
            if (idx !== -1) {
                 // Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ù‡Ø´ Ú©Ø±Ø¯Ù‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                users[idx].password = hashPassword(newPass);
                saveData();
                alert('âœ… Ø±Ù…Ø² Ø§Ø¯Ù…ÛŒÙ† ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.');
                closeModal('admin-password-modal');
            }
        }

        // --- RENDER HELPERS ---
        function renderCategorySelectors() {
            const selectors = document.querySelectorAll('.category-select');
            selectors.forEach(selectEl => {
                selectEl.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            });
        }

        function renderCategoryManagement() {
            const listEl = document.getElementById('category-management-list');
            if (listEl) {
                listEl.innerHTML = categories.map(cat => 
                    `<li><span>${cat}</span> <button class="btn-cancel" onclick="deleteCategory('${cat}')" style="width: auto; padding: 5px 10px; margin: 0;"><i class="fas fa-trash"></i></button></li>`
                ).join('');
            }
        }

        function renderSpecsList(specsString) {
            if (!specsString) return '';
            const specsArray = specsString.split(',').map(s => `<li>${s.trim()}</li>`).join('');
            return `<ul class="specs-list">${specsArray}</ul>`;
        }

        // --- SHOP & CART ---
        function filterProducts(cat) {
            currentFilter = cat;
            renderShop();
        }

        function renderShop() {
            const searchQuery = document.getElementById('product-search-input')?.value.toLowerCase().trim() || '';

            const categoryMenu = document.getElementById('category-menu');
            categoryMenu.innerHTML = `<button onclick="filterProducts('Ù‡Ù…Ù‡')" ${currentFilter === 'Ù‡Ù…Ù‡' ? 'class="active"' : ''}>Ù‡Ù…Ù‡</button>` +
                categories.map(cat => `<button onclick="filterProducts('${cat}')" ${currentFilter === cat ? 'class="active"' : ''}>${cat}</button>`).join('');
            
            const filteredProducts = products.filter(p => 
                (currentFilter === 'Ù‡Ù…Ù‡' || p.category === currentFilter) && 
                (p.name.toLowerCase().includes(searchQuery))
            );

            document.getElementById('product-grid').innerHTML = filteredProducts.map(p => `
                <div class="card">
                    <img src="${p.img}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/300'">
                    <div class="card-body">
                        <div>
                            <div class="card-title">${p.name}</div>
                            <div class="price-row">${p.off ? `<span class="price-old">${p.price.toLocaleString()}</span> <span class="price-new">${p.off.toLocaleString()} Øª</span>` : `<span class="price-new">${p.price.toLocaleString()} Øª</span>`}</div>
                            ${renderSpecsList(p.specs)}
                        </div>
                        <button class="btn btn-add" style="margin-top: 15px;" onclick="addToCart(${p.id})">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯</button>
                    </div>
                </div>
            `).join('');
        }

        function addToCart(id) {
            cart.push({id});
            saveData();
            alert('âœ… Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.');
        }

        function delCart(index) {
            cart.splice(index, 1);
            saveData();
        }

        function calculateCartTotals() {
            const itemTotal = cart.reduce((sum, c) => {
                const p = products.find(x => x.id === c.id);
                return sum + (p ? (p.off || p.price) : 0) * (c.qty || 1); // Assuming quantity 1 if not specified
            }, 0);
            return { itemTotal, finalTotal: itemTotal + (itemTotal > 0 ? SHIPPING_COST : 0) };
        }

        function renderCart() {
            const cEl = document.getElementById('cart-items');
            document.getElementById('shipping-cost-display').innerText = `${SHIPPING_COST.toLocaleString()} ØªÙˆÙ…Ø§Ù†`;

            if(!cart.length) {
                cEl.innerHTML='<p style="text-align:center">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</p>';
                document.getElementById('cart-total').innerText='Ø¬Ù…Ø¹ Ú©Ù„ Ù†Ù‡Ø§ÛŒÛŒ: Û° ØªÙˆÙ…Ø§Ù†';
                document.getElementById('cart-count').innerText = 0;
                return;
            }

            const { finalTotal } = calculateCartTotals();
            cEl.innerHTML = cart.map((c,i) => {
                const p = products.find(x=>x.id===c.id);
                if(!p) return '';
                return `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #444;"><span>${p.name}</span><span>${(p.off||p.price).toLocaleString()} Øª <button onclick="delCart(${i})" style="color:red; background:none; border:none; cursor:pointer; font-weight:bold;">X</button></span></div>`;
            }).join('');
            
            document.getElementById('cart-count').innerText = cart.length;
            document.getElementById('cart-total').innerText = `Ø¬Ù…Ø¹ Ú©Ù„ Ù†Ù‡Ø§ÛŒÛŒ: ${finalTotal.toLocaleString()} ØªÙˆÙ…Ø§Ù†`;
        }

        function goToShipping() {
            if (!currentUser) return switchTab('login');
            if (!cart.length) return alert('Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.');
            updateShippingFormTotal();
            switchTab('shipping');
        }

        function updateShippingFormTotal() {
            const totalEl = document.getElementById('final-total-display');
            if (totalEl) totalEl.innerText = `${calculateCartTotals().finalTotal.toLocaleString()} ØªÙˆÙ…Ø§Ù†`;
        }

        function submitShippingForm(e) {
            e.preventDefault();
            if (!cart.length) return alert('Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.');

            const shippingInfo = {
                name: document.getElementById('ship-name').value.trim(),
                phone: document.getElementById('ship-phone').value.trim(),
                address: document.getElementById('ship-address').value.trim(),
                plaque: document.getElementById('ship-plaque').value.trim(),
                postal: document.getElementById('ship-postal').value.trim(),
            };
            const paymentInfo = {
                owner: document.getElementById('payment-owner-name').value.trim(),
                last4: document.getElementById('payment-last-digits').value.trim(),
            };
            const { finalTotal } = calculateCartTotals();
            const orderItems = cart.map(c => {
                const p = products.find(x => x.id === c.id);
                return `${p.name} (${(p.off || p.price).toLocaleString()} Øª)`;
            });

            const newOrder = {
                id: Date.now(),
                customer: currentUser,
                items: orderItems,
                total: finalTotal,
                shipping_info: shippingInfo,
                payment_info: paymentInfo,
                status: 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯',
                cancellation_note: null,
            };

            orders.push(newOrder);
            lastShippingInfo[currentUser] = shippingInfo;
            cart = [];
            saveData();
            alert(`âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯. Ù…Ø¨Ù„Øº ${finalTotal.toLocaleString()} ØªÙˆÙ…Ø§Ù† Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.`);
            switchTab('user-orders');
        }

        // --- PROFILE & ORDERS ---
        function renderUserProfile() {
            const profileEl = document.getElementById('user-profile-info');
            if (!profileEl || !currentUser) return;

            const userInfo = users.find(u => u.username === currentUser);
            
            // Ø§ØµÙ„Ø§Ø­ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ø®Ø·Ø§ÛŒ Uncaught TypeError
            if (!userInfo) {
                profileEl.innerHTML = '<p style="text-align:center; color: var(--danger);">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
                return; 
            }

            const shipping = lastShippingInfo[currentUser];
            // Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØªØŒ Ø±Ù…Ø² Ù‡Ø´ Ø´Ø¯Ù‡ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
            const maskedPassword = userInfo.password.substring(0, 4) + '...';

            let html = `<div class="profile-info-box">
                <h3><i class="fas fa-id-badge"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨</h3>
                <p><strong>Ú©Ø§Ø±Ø¨Ø±ÛŒ:</strong> ${userInfo.username}</p>
                <p><strong>Ø±Ù…Ø² (Ù‡Ø´):</strong> ${maskedPassword}</p>
                ${isAdminLoggedIn ?
                    `<button class="btn-admin-action" onclick="document.getElementById('admin-password-modal').style.display='block';" style="width: auto;"><i class="fas fa-key"></i> Ø±Ù…Ø² Ø§Ø¯Ù…ÛŒÙ†</button>` : ''}
                </div>`;
            
            if (shipping) {
                html += `<div class="profile-info-box">
                    <h3><i class="fas fa-shipping-fast"></i> Ø¢Ø¯Ø±Ø³ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡</h3>
                    <p><strong>Ú¯ÛŒØ±Ù†Ø¯Ù‡:</strong> ${shipping.name}</p>
                    <p><strong>ØªÙ…Ø§Ø³:</strong> ${shipping.phone}</p>
                    <p><strong>Ø¢Ø¯Ø±Ø³:</strong> ${shipping.address}</p>
                    <p><strong>Ù¾Ù„Ø§Ú©:</strong> ${shipping.plaque}ØŒ <strong>Ú©Ø¯Ù¾Ø³ØªÛŒ:</strong> ${shipping.postal}</p>
                </div>`;
            } else {
                html += `<p style="text-align:center; color: var(--warning);">Ù‡Ù†ÙˆØ² Ø³ÙØ§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.</p>`;
            }

            profileEl.innerHTML = html;
        }

        function toggleOrderDetails(orderId) {
            const detailEl = document.getElementById(`order-details-${orderId}`);
            if (detailEl) detailEl.classList.toggle('show');
        }

        function renderUserOrders() {
            const list = orders.filter(o=>o.customer===currentUser).sort((a,b)=>b.id-a.id);
            const listEl = document.getElementById('user-orders-list');

            listEl.innerHTML = list.length ? list.map(o => {
                const statusColor = o.status === 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡' ? 'var(--success)' : 
                                    o.status === 'Ù„ØºÙˆ Ø´Ø¯Ù‡' ? '#e74c3c' : 
                                    o.status === 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øª' ? 'var(--danger)' : '#f1c40f';

                const addressDetails = o.shipping_info ? 
                    `<p>Ú¯ÛŒØ±Ù†Ø¯Ù‡: ${o.shipping_info.name} | ØªÙ…Ø§Ø³: ${o.shipping_info.phone}</p><p>Ø¢Ø¯Ø±Ø³: ${o.shipping_info.address}</p>` : '';
                
                const itemsList = o.items.length ? 
                    `<ul class="item-list">${o.items.map(item => `<li>${item}</li>`).join('')}</ul>` : '';
                
                const cancellation = o.status === 'Ù„ØºÙˆ Ø´Ø¯Ù‡' && o.cancellation_note ? 
                    `<div class="cancellation-alert" style="color:var(--danger); font-weight:bold; margin-bottom:10px;">âš ï¸ Ø¯Ù„ÛŒÙ„ Ù„ØºÙˆ: ${o.cancellation_note}</div>` : '';

                return `
                    <div class="order-summary" style="border-right-color: ${statusColor};">
                        <div class="order-header" onclick="toggleOrderDetails(${o.id})">
                            <div><strong>#${o.id%100}</strong> <small>${new Date(o.id).toLocaleDateString('fa-IR')}</small> | <span style="color:${statusColor}">${o.status}</span></div>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div id="order-details-${o.id}" class="order-details">${cancellation}<br>${addressDetails}${itemsList}</div>
                    </div>`;
            }).join('') : '<p style="text-align:center">Ø³ÙØ§Ø±Ø´ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.</p>';
        }

        // --- ADMIN PANEL: PRODUCTS ---
        function addProduct(e) {
            e.preventDefault();
            if (!isAdminLoggedIn) return alert('ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†!');
            
            const newProduct = {
                id: Date.now(),
                name: document.getElementById('p-name').value.trim(),
                price: parseInt(document.getElementById('p-price').value),
                off: document.getElementById('p-off').value ? parseInt(document.getElementById('p-off').value) : null,
                img: document.getElementById('p-img').value.trim() || "https://via.placeholder.com/300/4e5458/ffffff?text=NO+IMAGE",
                category: document.getElementById('p-category').value,
                specs: [
                    document.getElementById('p-spec1').value.trim(),
                    document.getElementById('p-spec2').value.trim(),
                    document.getElementById('p-spec3').value.trim()
                ].filter(s => s).join(', ')
            };

            products.push(newProduct);
            saveData();
            e.target.reset();
            alert('âœ… Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.');
        }

        function delProd(id) {
            if (!isAdminLoggedIn) return alert('ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†!');
            if (confirm('Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ØŸ')) {
                products = products.filter(p => p.id !== id);
                saveData();
            }
        }

        function renderAdminProducts() {
            document.getElementById('admin-grid').innerHTML = products.map((p,i) => `
                <div class="card"><div class="card-body" style="text-align:center">
                    <img src="${p.img}" style="height:80px; margin-bottom:10px;" alt="thumb"> <br>
                    <strong>${p.name}</strong><br><span style="font-size:0.8em; color:#aaa;">${p.category}</span><br>
                    <button class="btn btn-del" onclick="delProd(${p.id})">Ø­Ø°Ù</button>
                    <button class="btn btn-edit" onclick="editProduct(${p.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                </div></div>
            `).join('');
        }
        
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('edit-product-form').dataset.productId = productId;
            document.getElementById('edit-p-name').value = product.name;
            document.getElementById('edit-p-img').value = product.img;
            document.getElementById('edit-p-price').value = product.price;
            document.getElementById('edit-p-off').value = product.off;
            document.getElementById('edit-p-category').value = product.category;

            const specs = product.specs ? product.specs.split(',').map(s => s.trim()) : [];
            document.getElementById('edit-p-specs1').value = specs[0] || '';
            document.getElementById('edit-p-specs2').value = specs[1] || '';
            document.getElementById('edit-p-specs3').value = specs[2] || '';
            
            document.getElementById('edit-modal').style.display = 'block';
        }

        function saveEditedProduct(id) {
            const product = products.find(p => p.id === parseInt(id));
            if (!product) return;

            product.name = document.getElementById('edit-p-name').value.trim();
            product.img = document.getElementById('edit-p-img').value.trim() || "https://via.placeholder.com/300/4e5458/ffffff?text=NO+IMAGE";
            product.price = parseInt(document.getElementById('edit-p-price').value);
            product.off = document.getElementById('edit-p-off').value ? parseInt(document.getElementById('edit-p-off').value) : null;
            product.category = document.getElementById('edit-p-category').value;
            
            const specs = [
                document.getElementById('edit-p-specs1').value.trim(),
                document.getElementById('edit-p-specs2').value.trim(),
                document.getElementById('edit-p-specs3').value.trim()
            ].filter(s => s).join(', ');
            product.specs = specs;

            saveData();
            alert('âœ… Ù…Ø­ØµÙˆÙ„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯.');
            closeModal('edit-modal');
        }

        // --- ADMIN PANEL: CATEGORIES ---
        function addCategory(e) {
            e.preventDefault();
            if (!isAdminLoggedIn) return alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯.');

            const newCat = document.getElementById('new-category-name').value.trim();
            if (newCat && !categories.includes(newCat)) {
                categories.push(newCat);
                saveData();
                alert(`âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`);
                e.target.reset();
            } else {
                alert('ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª.');
            }
        }

        function deleteCategory(catName) {
            if (!isAdminLoggedIn) return;
            if (products.some(p => p.category === catName)) 
                return alert('Ø§Ø¨ØªØ¯Ø§ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯.');

            if (confirm(`Ø­Ø°Ù Ø¯Ø³ØªÙ‡ "${catName}"ØŸ`)) {
                categories = categories.filter(cat => cat !== catName);
                if (currentFilter === catName) currentFilter = 'Ù‡Ù…Ù‡';
                saveData();
            }
        }

        // --- ADMIN PANEL: ORDERS ---
        function renderAdminOrders() {
            const searchUser = document.getElementById('order-search-input')?.value.toLowerCase().trim() || '';
            const filteredOrders = orders.filter(o => o.customer.toLowerCase().includes(searchUser)).sort((a,b)=>b.id-a.id);
            
            document.getElementById('orders-list').innerHTML = filteredOrders.length ? 
                filteredOrders.map(o => {
                    const statusColor = o.status === 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡' ? 'var(--success)' : 
                                        o.status === 'Ù„ØºÙˆ Ø´Ø¯Ù‡' ? '#e74c3c' : 
                                        o.status === 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øª' ? 'var(--danger)' : '#f1c40f';

                    const addressDetails = o.shipping_info ? 
                        `<p>Ú¯ÛŒØ±Ù†Ø¯Ù‡: ${o.shipping_info.name} | ØªÙ…Ø§Ø³: ${o.shipping_info.phone}</p><p>Ø¢Ø¯Ø±Ø³: ${o.shipping_info.address} Ù¾Ù„Ø§Ú© ${o.shipping_info.plaque} Ú©Ø¯Ù¾Ø³ØªÛŒ ${o.shipping_info.postal}</p>` : '';
                    
                    const paymentDetails = o.payment_info ? 
                        `<p>ÙˆØ§Ø±ÛŒØ² Ú©Ù†Ù†Ø¯Ù‡: ${o.payment_info.owner} | Û´ Ø±Ù‚Ù… Ø¢Ø®Ø± Ú©Ø§Ø±Øª: **** ${o.payment_info.last4}</p><p>Ù…Ø¨Ù„Øº: ${o.total.toLocaleString()} ØªÙˆÙ…Ø§Ù†</p>` : '';
                    
                    const itemsList = o.items.length ? 
                        `<h4 style="color:var(--primary)">Ù…Ø­ØµÙˆÙ„Ø§Øª:</h4><ul class="item-list" style="list-style:decimal; margin-right:20px; text-align:right;">${o.items.map(item => `<li>${item}</li>`).join('')}</ul>` : '';
                    
                    const cancellation = o.status === 'Ù„ØºÙˆ Ø´Ø¯Ù‡' && o.cancellation_note ? 
                        `<div class="cancellation-alert" style="color:var(--danger); font-weight:bold; margin-bottom:10px;">âš ï¸ Ø¯Ù„ÛŒÙ„ Ù„ØºÙˆ: ${o.cancellation_note}</div>` : '';

                    const actions = o.status !== 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡' && o.status !== 'Ù„ØºÙˆ Ø´Ø¯Ù‡' ? `
                        <button class="btn btn-add" style="width:auto; padding: 8px 15px; margin-left: 10px;" onclick="updateOrderStatus(${o.id}, 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡')">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯</button>
                        <button class="btn-cancel" style="width:auto; padding: 8px 15px;" onclick="promptCancelOrder(${o.id})">Ù„ØºÙˆ</button>
                    ` : '';

                    return `
                        <div class="order-summary" style="border-right-color: ${statusColor}; margin-bottom: 20px;">
                            <div class="order-header" onclick="toggleOrderDetails(${o.id})">
                                <div><strong>Ø³ÙØ§Ø±Ø´ #${o.id%100}</strong> - ${o.customer} | <span style="color:${statusColor}">${o.status}</span></div>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div id="order-details-${o.id}" class="order-details">
                                ${cancellation}
                                <h4 style="color:var(--primary)">Ø§Ø±Ø³Ø§Ù„:</h4>${addressDetails}
                                <h4 style="color:var(--primary)">Ù¾Ø±Ø¯Ø§Ø®Øª:</h4>${paymentDetails}
                                ${itemsList}
                                <div style="margin-top:10px; border-top:1px solid #444; padding-top:10px;">${actions}</div>
                            </div>
                        </div>`;
                }).join('') : '<p style="text-align:center">Ø³ÙØ§Ø±Ø´ÛŒ Ù†ÛŒØ³Øª.</p>';
        }

        function updateOrderStatus(id, newStatus) {
            const order = orders.find(o => o.id === id);
            if (!order) return;
            order.status = newStatus;
            order.cancellation_note = null;
            saveData();
            renderAdminOrders();
        }

        function promptCancelOrder(id) {
            const reason = prompt("Ù„Ø·ÙØ§ Ø¯Ù„ÛŒÙ„ Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
            if (reason) {
                const order = orders.find(o => o.id === id);
                if (!order) return;
                order.status = 'Ù„ØºÙˆ Ø´Ø¯Ù‡';
                order.cancellation_note = reason;
                saveData();
                renderAdminOrders();
            }
        }

        // --- ADMIN PANEL: USERS ---
        function renderAdminUsers() {
            if (!isAdminLoggedIn) return;
            const searchUser = document.getElementById('user-search-input')?.value.toLowerCase().trim() || '';
            const filteredUsers = users.filter(u => u.username.toLowerCase().includes(searchUser));
            const listEl = document.getElementById('users-list-container');

            if (!filteredUsers.length) {
                listEl.innerHTML = '<p style="text-align:center">ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
                return;
            }

            listEl.innerHTML = `
                <table class="user-table">
                    <thead><tr><th>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</th><th>Ø±Ù…Ø² (Ù‡Ø´)</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead>
                    <tbody>${filteredUsers.map(u => `
                        <tr>
                            <td>${u.username}</td>
                            <td>${u.password.substring(0, 8)}...</td>
                            <td>
                                <button onclick="openUserPasswordModal('${u.username}')" class="btn-password">ØªØºÛŒÛŒØ± Ø±Ù…Ø²</button>
                            </td>
                        </tr>
                    `).join('')}</tbody>
                </table>`;
        }
        
        // --- INITIALIZATION ---
        render();
        window.onclick = function(event) {
            if (!event.target.matches('.user-menu-container button')) {
                const dropdowns = document.getElementsByClassName("user-dropdown");
                for (let i = 0; i < dropdowns.length; i++) { if (dropdowns[i].classList.contains('show')) dropdowns[i].classList.remove('show'); }
            }
            if (event.target.classList.contains('modal')) event.target.style.display = "none";
        }
    </script>
</body>
</html>
